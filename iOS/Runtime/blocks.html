<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OC Blocks All in One | Hello Vue Press</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/blogs/assets/css/0.styles.c657c6cf.css" as="style"><link rel="preload" href="/blogs/assets/js/app.140aea6c.js" as="script"><link rel="preload" href="/blogs/assets/js/2.733019b2.js" as="script"><link rel="preload" href="/blogs/assets/js/10.0e1ff1aa.js" as="script"><link rel="prefetch" href="/blogs/assets/js/11.9bd0684d.js"><link rel="prefetch" href="/blogs/assets/js/3.4122aa84.js"><link rel="prefetch" href="/blogs/assets/js/4.d12742be.js"><link rel="prefetch" href="/blogs/assets/js/5.216cae74.js"><link rel="prefetch" href="/blogs/assets/js/6.2d0a63f8.js"><link rel="prefetch" href="/blogs/assets/js/7.a0edaaa4.js"><link rel="prefetch" href="/blogs/assets/js/8.bacf6399.js"><link rel="prefetch" href="/blogs/assets/js/9.e99fbde1.js">
    <link rel="stylesheet" href="/blogs/assets/css/0.styles.c657c6cf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blogs/" class="home-link router-link-active"><!----> <span class="site-name">Hello Vue Press</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/blogs/" aria-current="page" class="sidebar-link">Hello VuePress</a></li><li><a href="/blogs/iOS/" aria-current="page" class="sidebar-link">iOS</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="oc-blocks-all-in-one"><a href="#oc-blocks-all-in-one" class="header-anchor">#</a> OC Blocks All in One</h1> <h2 id="intruduction"><a href="#intruduction" class="header-anchor">#</a> Intruduction</h2> <p>A Block is an <strong>object</strong> / <strong>c-structure</strong> / <strong>function with data</strong> that ecapsulate a piece of code and variables, and can be invoked / executed later.</p> <p>Blocks are the building blocks for iOS multi-thread programming, and are extensively used in callbacks / delegation / &lt;maybe some others&gt;</p> <p>Block syntax tip: http://fuckingblocksyntax.com/</p> <h2 id="tips-for-using"><a href="#tips-for-using" class="header-anchor">#</a> Tips for Using</h2> <ol><li>avoid strong reference cycle</li> <li>use <code>__block</code> modifiers in case if you want to modify a captured variable in a block.</li></ol> <h2 id="anatomy-of-a-block"><a href="#anatomy-of-a-block" class="header-anchor">#</a> Anatomy of a Block</h2> <p>Take the simplest block as an example:</p> <div class="language-Objective-C extra-class"><pre class="language-text"><code>void(^myBlock)(void) = ^(void) {
    NSLog(@&quot;%d %d %d %d&quot;, local_nonstatic, local_static, global_nonstatic, global_static);
};
</code></pre></div><p>It is implemented with three structures: impl, func, desc.</p> <h3 id="impl"><a href="#impl" class="header-anchor">#</a> Impl</h3> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">__main_block_impl_1</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">__block_impl</span> impl<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">__main_block_desc_1</span><span class="token operator">*</span> Desc<span class="token punctuation">;</span>
  <span class="token keyword">int</span> local_nonstatic<span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token operator">*</span>local_static<span class="token punctuation">;</span>
  <span class="token function">__main_block_impl_1</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">__main_block_desc_1</span> <span class="token operator">*</span>desc<span class="token punctuation">,</span> <span class="token keyword">int</span> _local_nonstatic<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>_local_static<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">local_nonstatic</span><span class="token punctuation">(</span>_local_nonstatic<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">local_static</span><span class="token punctuation">(</span>_local_static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    impl<span class="token punctuation">.</span>isa <span class="token operator">=</span> <span class="token operator">&amp;</span>_NSConcreteStackBlock<span class="token punctuation">;</span>
    impl<span class="token punctuation">.</span>Flags <span class="token operator">=</span> flags<span class="token punctuation">;</span>
    impl<span class="token punctuation">.</span>FuncPtr <span class="token operator">=</span> fp<span class="token punctuation">;</span>
    Desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>__main_block_impl_0</code> struct holds three things:</p> <ol><li><code>impl</code> (meta info, most important is the FuncPtr that points to the block's code),</li> <li><code>Desc</code> description of the block (see following),</li> <li>external variables captured by the block (in this example, <code>local_nonstatic</code> and <code>local_static</code>)
<ol><li>auto variables are captured by value</li> <li>local statics are captured by pointer</li> <li>global statics and nonstatics are not captured, but directly referenced.</li></ol></li></ol> <h3 id="func"><a href="#func" class="header-anchor">#</a> Func</h3> <p>A static c function will be generated for this block and it encapsulated the actual code to execute.</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__main_block_func_1</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__main_block_impl_1</span> <span class="token operator">*</span>__cself<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> local_nonstatic <span class="token operator">=</span> __cself<span class="token operator">-&gt;</span>local_nonstatic<span class="token punctuation">;</span> <span class="token comment">// bound by copy</span>
  <span class="token keyword">int</span> <span class="token operator">*</span>local_static <span class="token operator">=</span> __cself<span class="token operator">-&gt;</span>local_static<span class="token punctuation">;</span> <span class="token comment">// bound by copy</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>__NSConstantStringImpl__var_folders_qc_t2xr6bnn27nfywg43j28jtqc0000gp_T_main_5a80bd_mi_0<span class="token punctuation">,</span> local_nonstatic<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>local_static<span class="token punctuation">)</span><span class="token punctuation">,</span> global_nonstatic<span class="token punctuation">,</span> global_static<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="desc"><a href="#desc" class="header-anchor">#</a> Desc</h3> <p>The Desc struct describes the size and helper information (discussed later) of the Impl struct.</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">__main_block_desc_1</span> <span class="token punctuation">{</span>
  <span class="token class-name">size_t</span> reserved<span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> Block_size<span class="token punctuation">;</span>
<span class="token punctuation">}</span> __main_block_desc_1_DATA <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__main_block_impl_1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="block-modifier"><a href="#block-modifier" class="header-anchor">#</a> __block Modifier</h2> <p>In the example above, the local variable is captured by value and that is why we cannot modify its value inside the block. In order to modify its value, we can add a <code>__block</code> modifier at its declaration, let's see what will be changed.</p> <p>Code:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token number">1.</span> <span class="token class-name">dispatch_block_t</span> <span class="token function">getBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2.</span>     <span class="token keyword">static</span> <span class="token keyword">int</span> local_static<span class="token punctuation">;</span>
<span class="token number">3.</span>     __block <span class="token keyword">int</span> local_nonstatic<span class="token punctuation">;</span>
<span class="token number">4.</span>     
<span class="token number">5.</span>     <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>myBlock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6.</span>         local_nonstatic <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token number">7.</span>         <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;%d %d %d %d&quot;</span><span class="token punctuation">,</span> local_nonstatic<span class="token punctuation">,</span> local_static<span class="token punctuation">,</span> global_nonstatic<span class="token punctuation">,</span> global_static<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">8.</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">9.</span>     <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;%@&quot;</span><span class="token punctuation">,</span> myBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">10.</span>     <span class="token keyword">return</span> myBlock<span class="token punctuation">;</span>
<span class="token number">11.</span> <span class="token punctuation">}</span>
</code></pre></div><ol><li><p><code>local_nonstatic</code> in the 3rd line is initialized as a structure, not a simple integer.</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">__Block_byref_local_nonstatic_0</span> <span class="token punctuation">{</span>
<span class="token keyword">void</span> <span class="token operator">*</span>__isa<span class="token punctuation">;</span>
__Block_byref_local_nonstatic_0 <span class="token operator">*</span>__forwarding<span class="token punctuation">;</span>
<span class="token keyword">int</span> __flags<span class="token punctuation">;</span>
<span class="token keyword">int</span> __size<span class="token punctuation">;</span>
<span class="token keyword">int</span> local_nonstatic<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

__Block_byref_local_nonstatic_0 local_nonstatic <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>__Block_byref_local_nonstatic_0 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>local_nonstatic<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__Block_byref_local_nonstatic_0<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>the code for changing the value of <code>local_nonstatic</code> is</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__getBlock_block_func_0</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__getBlock_block_impl_0</span> <span class="token operator">*</span>__cself<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    __Block_byref_local_nonstatic_0 <span class="token operator">*</span>local_nonstatic <span class="token operator">=</span> __cself<span class="token operator">-&gt;</span>local_nonstatic<span class="token punctuation">;</span> <span class="token comment">// bound by ref</span>
    <span class="token punctuation">(</span>local_nonstatic<span class="token operator">-&gt;</span>__forwarding<span class="token operator">-&gt;</span>local_nonstatic<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We're using the <code>__forwarding</code> pointer to access the <code>local_nonstatic</code> field in the byref structure. <code>__forwarding</code> is initialized as address of the byref structure on the stack.</p></li> <li><p>a <code>copy</code> and a <code>dispose</code> function pointer are added to the <code>Desc</code> structure</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__getBlock_block_copy_0</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__getBlock_block_impl_0</span><span class="token operator">*</span>dst<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">__getBlock_block_impl_0</span><span class="token operator">*</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">_Block_object_assign</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dst<span class="token operator">-&gt;</span>local_nonstatic<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token operator">-&gt;</span>local_nonstatic<span class="token punctuation">,</span> <span class="token number">8</span><span class="token comment">/*BLOCK_FIELD_IS_BYREF*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__getBlock_block_dispose_0</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__getBlock_block_impl_0</span><span class="token operator">*</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">_Block_object_dispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token operator">-&gt;</span>local_nonstatic<span class="token punctuation">,</span> <span class="token number">8</span><span class="token comment">/*BLOCK_FIELD_IS_BYREF*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">__getBlock_block_desc_0</span> <span class="token punctuation">{</span>
<span class="token class-name">size_t</span> reserved<span class="token punctuation">;</span>
<span class="token class-name">size_t</span> Block_size<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>copy<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__getBlock_block_impl_0</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">__getBlock_block_impl_0</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dispose<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__getBlock_block_impl_0</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> __getBlock_block_desc_0_DATA <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">__getBlock_block_impl_0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> __getBlock_block_copy_0<span class="token punctuation">,</span> __getBlock_block_dispose_0<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>copy</code> and <code>dispose</code> are helper functions for the compiler to copy or release a block.</p> <p>When a block is copied to the heap, the byref structure is also copied to the heap.</p> <ul><li>The <code>__forwarding</code> pointer of the original stack byref will from now on points to the byref structure on the heap.</li> <li>The <code>__forwarding</code> pointer of the new heap byref will points to itself.</li></ul></li> <li><p>the <code>flags</code> field in the <code>Impl</code> are no longer 0:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>myBlock<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token function">__main_block_impl_0</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>__main_block_func_0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>__main_block_desc_0_DATA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>local_static<span class="token punctuation">,</span> <span class="token punctuation">(</span>__Block_byref_local_nonstatic_0 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>local_nonstatic<span class="token punctuation">,</span> <span class="token number">570425344</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>570425344 = (1 &lt;&lt; 25) | (1 &lt;&lt; 29)</code>, from <a href="https://clang.llvm.org/docs/Block-ABI-Apple.html#imported-variables" target="_blank" rel="noopener noreferrer">apple's ABI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> specification:</p> <div class="language-c extra-class"><pre class="language-c"><code> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
     BLOCK_IS_NOESCAPE      <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

     BLOCK_HAS_COPY_DISPOSE <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     BLOCK_HAS_CTOR <span class="token operator">=</span>          <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// helpers have C++ code</span>
     BLOCK_IS_GLOBAL <span class="token operator">=</span>         <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     BLOCK_HAS_STRET <span class="token operator">=</span>         <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// IFF BLOCK_HAS_SIGNATURE</span>
     BLOCK_HAS_SIGNATURE <span class="token operator">=</span>     <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>It states the Impl struct as custom copy / dispose helper functions. Currently I do not understand the <code>BLOCK_HAS_STRET</code> flag.</p></li></ol> <h2 id="types-of-blocks"><a href="#types-of-blocks" class="header-anchor">#</a> Types of Blocks</h2> <p>Summarized in https://www.jianshu.com/p/387730aec62a</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/blogs/assets/js/app.140aea6c.js" defer></script><script src="/blogs/assets/js/2.733019b2.js" defer></script><script src="/blogs/assets/js/10.0e1ff1aa.js" defer></script>
  </body>
</html>
